#!/usr/bin/env bash

#
# Adapted from the following guide:
# http://marketing.intracto.com/renew-https-certificate-on-amazon-cloudfront
#

DOMAIN=rosszurowski.com
CONFIG=cloudfront.json

DISTRIBUTION=$(aws cloudfront list-distributions \
  --query "DistributionList.Items[?Aliases.Items[0]=='$DOMAIN'].{DitributionId: Id}" \
  --output text \
)

OLD_CERTIFICATE=$(aws iam list-server-certificates \
  --output text \
  --query "ServerCertificateMetadataList[?ServerCertificateName=='$DOMAIN'].{IAMCertificateId: ServerCertificateId}" \
)
NEW_CERTIFICATE=$(aws iam list-server-certificates \
  --output text \
  --query "ServerCertificateMetadataList[?ServerCertificateName=='$DOMAIN-tmp'].{IAMCertificateId: ServerCertificateId}" \
)

aws cloudfront get-distribution-config \
  --id $DISTRIBUTION \
  --output json | jq '. | .DistributionConfig' > $CONFIG

sed -i "" "s/$OLD_CERTIFICATE/$NEW_CERTIFICATE/" $CONFIG

DISTRIBUTION_VERSION=$(aws cloudfront get-distribution-config \
  --id $DISTRIBUTION \
  --query "{ETag: ETag}" \
  --output text \
)

aws cloudfront update-distribution \
  --id $DISTRIBUTION \
  --if-match $DISTRIBUTION_VERSION \
  --distribution-config file://$CONFIG

aws iam delete-server-certificate \
  --server-certificate-name $DOMAIN
aws iam update-server-certificate \
  --server-certificate-name $DOMAIN-tmp \
  --new-server-certificate-name $DOMAIN

rm $CONFIG
